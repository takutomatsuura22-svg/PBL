# OpenAI API コスト管理ガイド

## 📊 トークンとは？

**トークン**は、OpenAI APIがテキストを処理する単位です。

- **日本語**: 約1文字 = 1〜2トークン
- **英語**: 約4文字 = 1トークン
- **例**: 「こんにちは」= 約5トークン

APIリクエストでは、**送信するテキスト（入力トークン）**と**返ってくるテキスト（出力トークン）**の合計が課金対象です。

---

## 💰 料金体系（GPT-4o-mini）

現在使用している `gpt-4o-mini` の料金（2024年12月時点）:

| 項目 | 料金 |
|------|------|
| **入力トークン** | $0.15 / 1Mトークン |
| **出力トークン** | $0.60 / 1Mトークン |

### 実際のコスト例

**1回の学生アドバイス生成**（約1,000〜1,500トークン）:
- コスト: 約 **$0.001**（約0.15円）

**使用量の目安:**
- 1,000回のリクエスト = 約 **$1.00**（約150円）
- 10,000回のリクエスト = 約 **$10.00**（約1,500円）

---

## ⚠️ リスク管理

### 1. 使用量の監視

OpenAIダッシュボードで使用量を確認:
```
https://platform.openai.com/usage
```

**確認項目:**
- 日次・月次の使用量
- トークン数とコスト
- リクエスト数

### 2. 使用制限の設定（重要！）

OpenAIダッシュボードで設定:

1. **Settings** → **Billing** → **Usage limits**
2. **Hard limit**（ハードリミット）を設定
   - 例: 月次 $10.00（約1,500円）
3. **Soft limit**（ソフトリミット）を設定
   - 例: 月次 $5.00（約750円）で通知
4. 制限に達したら**自動停止**

**推奨設定:**
- 開発環境: $5.00/月
- 本番環境: $20.00/月（必要に応じて調整）

### 3. アプリケーション側の対策

#### A. キャッシュ機能の実装

同じ学生・タスクの分析結果を一定時間キャッシュ:
```typescript
// 例: 24時間キャッシュ
const cacheKey = `ai-advice-${student_id}`
const cached = await cache.get(cacheKey)
if (cached) return cached
```

#### B. リクエスト頻度の制限

- 同じ学生のアドバイスは1日1回まで
- タスク分析は更新時のみ実行

#### C. フォールバック機能（既に実装済み）

OpenAI APIが利用できない場合、ルールベースの分析に自動切り替え:
```typescript
if (!isOpenAIEnabled()) {
  return generateFallbackAdvice(student, tasks)
}
```

---

## 🎯 コスト削減のベストプラクティス

### 1. プロンプトの最適化

**❌ 悪い例（長すぎる）:**
```
以下の学生の詳細な情報を分析して、包括的なアドバイスを生成してください。
学生の名前、MBTI、モチベーション、負荷、スキル、強み、弱み、タスク状況、
完了タスク、進行中タスク、未着手タスク、期限超過タスクをすべて考慮して...
```

**✅ 良い例（簡潔）:**
```
学生: ${name}, MBTI:${MBTI}, モチベ${motivation}/5, 負荷${load}/5
タスク: 完了${completed}, 進行中${inProgress}, 期限超過${overdue}
→ 簡潔なアドバイスを生成
```

### 2. max_tokensの制限

現在の設定: `max_tokens: 1500`
推奨: `max_tokens: 800`（十分な長さでコスト削減）

### 3. 必要時のみAIを使用

- 重要な学生・タスクのみAI分析
- 定期的な分析はルールベースで十分な場合もある

---

## 📈 使用量の予測

### シナリオ1: 小規模使用（推奨）

- 学生数: 10人
- 1日1回のアドバイス生成: 10回/日
- 月間: 300回
- **月額コスト: 約$0.30（約45円）**

### シナリオ2: 中規模使用

- 学生数: 50人
- 1日1回のアドバイス生成: 50回/日
- 月間: 1,500回
- **月額コスト: 約$1.50（約225円）**

### シナリオ3: 大規模使用

- 学生数: 100人
- 1日2回のアドバイス生成: 200回/日
- 月間: 6,000回
- **月額コスト: 約$6.00（約900円）**

---

## 🔒 セキュリティ対策

### 1. APIキーの保護

- ✅ 環境変数で管理（`.env.local`）
- ✅ Git管理外（`.gitignore`に追加済み）
- ❌ コードに直接記述しない

### 2. レート制限の実装

アプリケーション側でリクエスト数を制限:
```typescript
// 1分間に最大10リクエスト
const rateLimiter = new RateLimiter({
  windowMs: 60 * 1000,
  max: 10
})
```

---

## 🚨 緊急時の対応

### 使用量が予想以上に増えた場合

1. **即座に使用制限を設定**
   - OpenAIダッシュボード → Usage limits
   - 現在の使用量の2倍程度に設定

2. **アプリケーションを一時停止**
   - 環境変数から `OPENAI_API_KEY` を削除
   - フォールバック機能が自動的に動作

3. **原因を調査**
   - 使用量ログを確認
   - 異常なリクエストパターンを特定

---

## 📝 チェックリスト

### セットアップ時
- [ ] OpenAIダッシュボードで使用制限を設定
- [ ] 月次予算を設定（例: $10）
- [ ] 使用量アラートを設定

### 運用時
- [ ] 週1回、使用量を確認
- [ ] 異常な増加がないかチェック
- [ ] コストが予算内か確認

### 緊急時
- [ ] 使用制限を確認
- [ ] 必要に応じてAPIキーを無効化
- [ ] フォールバック機能が動作するか確認

---

## 💡 まとめ

### 重要なポイント

1. **GPT-4o-miniは非常に安価**（1,000回で約$1）
2. **使用制限を必ず設定**（予算超過を防ぐ）
3. **フォールバック機能がある**（APIが使えなくても動作）
4. **使用量を定期的に監視**（週1回チェック）

### 推奨設定

- **月次予算**: $10.00（約1,500円）
- **ハードリミット**: $10.00
- **ソフトリミット**: $5.00（通知用）

これで安心してChatGPT APIを使用できます！🎉

