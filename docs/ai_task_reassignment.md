# AIタスク再割り当て機能

AIが自動で提案し、許可/拒否で判断できるタスク再割り当て機能です。

---

## 🎯 機能概要

AIが学生の負荷・モチベーション・スキルを分析し、最適なタスク再割り当てを提案します。PMが許可すると、**AirtableとWBSの担当者も自動で更新**されます。

---

## 📍 アクセス方法

### PMページ（メイン）
- **URL**: `/pm`
- **表示**: 上位5件の提案を表示
- **機能**: 許可/拒否ボタンで即座に判断可能

### タスク再割り当て詳細ページ
- **URL**: `/pm/task-reassignments`
- **表示**: すべての提案を詳細表示
- **機能**: 詳細な理由と影響度スコアを確認して判断

---

## 🤖 AI提案の基準

### 再割り当てが提案される条件

1. **負荷が高い**（load_score >= 4）
2. **モチベーションが低い**（motivation_score <= 2）
3. **スキル不足**（タスクの必要スキルと学生のスキルにギャップがある）

### 提案スコアリング

以下の要素を総合的に評価（100点満点）:

- **負荷差**（30点）: 移管による負荷軽減効果
- **スキル適性**（30点）: 新しい担当者のスキル適性
- **モチベーション**（20点）: モチベーションの向上効果
- **相性**（10点）: チーム内の相性
- **負荷バランス**（10点）: チーム全体の負荷バランス

**優先度:**
- **高**: スコア50以上、または負荷>=4.5 OR モチベ<=1.5
- **中**: スコア30以上、または負荷>=4 OR モチベ<=2
- **低**: その他

---

## ✅ 許可時の動作

### 1. タスクデータの更新

- **tasks.json**: 担当者ID（assignee_id）を更新
- **ステータス**: 未完了タスクは「実行中（in_progress）」に変更

### 2. Airtableの更新

- **Tasksテーブル**: 担当者IDを自動更新
- **ステータス**: 未完了タスクは「in_progress」に変更
- **対応フィールド名**: `assignee_id`, `Assignee ID`, `Assignee`（自動検出）

### 3. WBSの更新

- **選択中のWBSファイル**: 担当者IDを自動更新
- **ステータス**: 未完了タスクは「in_progress」に変更
- **注意**: WBSが選択されていない場合はスキップ

### 4. 学生の負荷スコア再計算

- 両方の学生（移管元・移管先）の負荷スコアを自動再計算
- タスクの難易度・時間・締切から算出

---

## ❌ 拒否時の動作

- 提案がリストから削除されます
- データは変更されません
- 同じ提案は再度表示されません（記録されます）

---

## 💡 使用例

### 例1: PMページから即座に判断

1. `/pm` ページにアクセス
2. 「AIタスク再割当提案」セクションを確認
3. 提案を確認:
   ```
   タスク: ユーザーインタビュー設計
   山田太郎 → 佐藤花子
   理由: 山田太郎さんのタスク量が4.5/5と非常に高く、負荷軽減が急務です。
   ```
4. **「✅ 許可」ボタンをクリック**
5. 自動で以下が更新されます:
   - ✅ AirtableのTasksテーブル
   - ✅ WBSファイル
   - ✅ 学生の負荷スコア

### 例2: 詳細ページで慎重に判断

1. `/pm/task-reassignments` ページにアクセス
2. 提案の詳細を確認:
   - 負荷の比較（グラフ表示）
   - モチベーションの比較（グラフ表示）
   - 影響度スコア（0-100）
   - 詳細な理由（複数の観点から説明）
3. 判断して許可/拒否

---

## 🔧 技術的な詳細

### APIエンドポイント

**提案の取得:**
```
GET /api/pm/task-reassignments
```

**提案の実行:**
```
POST /api/pm/task-reassignments/{taskId}/execute
Body: { "to_student_id": "S003" }
```

**提案の拒否:**
```
POST /api/pm/task-reassignments/{taskId}/reject
Body: { "reason": "理由（任意）" }
```

### 実装ファイル

- **AIロジック**: `backend/ai/task_reassign.ts`
- **APIエンドポイント**: `frontend/app/api/pm/task-reassignments/`
- **Airtable更新**: `frontend/lib/airtable-update.ts`
- **WBS更新**: `frontend/lib/wbs-update.ts`
- **UI**: `frontend/app/pm/page.tsx`, `frontend/app/pm/task-reassignments/page.tsx`

---

## ⚠️ 注意事項

### Airtableの更新

- Airtable APIキーに `data.records:write` 権限が必要
- タスクが見つからない場合、更新はスキップされます（エラーにはなりません）
- フィールド名は自動検出されます（`assignee_id`, `Assignee ID`, `Assignee`）

### WBSの更新

- WBSが選択されていない場合、更新はスキップされます
- 選択中のWBSファイルのみ更新されます
- WBSファイルは `backend/data/wbs/{wbs_id}.json` に保存されます

### エラーハンドリング

- Airtableの更新に失敗しても、タスクデータとWBSは更新されます
- エラーメッセージに更新結果が含まれます:
  ```
  タスク「XXX」をYYYさんに再割り当てしました。
  Airtableの担当者を更新しました。
  WBSの担当者を更新しました。
  ```

---

## 📊 提案の例

### 高優先度の提案

```
タスク: プロジェクト企画書の作成
山田太郎（負荷4.5/5, モチベ2/5） → 佐藤花子（負荷2/5, モチベ4/5）

理由:
【緊急】山田太郎さんは現在タスク量が4.5/5と非常に高く、負荷軽減が急務です。
佐藤花子さん（タスク量2/5）に移管することで、2.5ポイント（50%）の負荷軽減が可能です。
【重要】佐藤花子さんはモチベーションが4/5と高く（山田太郎さん: 2/5）、
作業効率と品質が40%向上する可能性があります。
【重要】企画スキルが2/5から5/5に大幅に向上（3ポイント、60%向上）。
タスク「プロジェクト企画書の作成」の品質と完了速度が大幅に向上します。
```

---

## 🎯 ベストプラクティス

### 1. 提案の確認

- **負荷の比較**: 移管による負荷軽減効果を確認
- **モチベーション**: 新しい担当者のモチベーションが高いか確認
- **スキル適性**: タスクのカテゴリに適したスキルがあるか確認

### 2. 判断のタイミング

- **即座に許可**: 明らかに負荷が高すぎる場合
- **慎重に判断**: スキル適性や相性を考慮する必要がある場合
- **拒否**: 提案が適切でない場合（理由を記録）

### 3. チームへの通知

- 許可後、学生にタスクの移管を通知することを推奨
- Airtableで確認できるため、学生も自動的に把握可能

---

## 🔄 更新の流れ

```
1. AIが提案を生成
   ↓
2. PMが提案を確認
   ↓
3. 「許可」ボタンをクリック
   ↓
4. 以下が自動実行:
   - tasks.json を更新
   - Airtable Tasksテーブルを更新
   - WBSファイルを更新
   - 学生の負荷スコアを再計算
   ↓
5. 完了メッセージを表示
```

---

## 📝 トラブルシューティング

### Airtableが更新されない

**原因:**
- APIキーの権限不足
- タスクが見つからない
- フィールド名が異なる

**解決方法:**
1. Airtable APIキーに `data.records:write` 権限があるか確認
2. タスクIDが正しいか確認
3. AirtableのTasksテーブルでフィールド名を確認

### WBSが更新されない

**原因:**
- WBSが選択されていない
- WBSファイルが見つからない

**解決方法:**
1. `/wbs` ページでWBSが選択されているか確認
2. `backend/data/wbs_config.json` を確認

---

**🎉 AIタスク再割り当て機能で、効率的なタスク管理を実現しましょう！**

